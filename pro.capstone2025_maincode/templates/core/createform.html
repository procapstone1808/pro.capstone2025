{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if object %}Editar propiedad{% else %}Crear propiedad{% endif %} · StockPRO
{% endblock %}

{% block nav_items %}
    <li class="nav-item"><a class="nav-link" href="{% url 'core:main-registrado' %}">Perfil</a></li>
    <li class="nav-item"><a class="nav-link" href="{% url 'core:propiedadcrud' %}">Propiedades</a></li>
    <li class="nav-item"><a class="nav-link" href="{% url 'core:propiedadcrud' %}">Volver</a></li>
    <li class="nav-item"><a class="nav-link text-danger" href="{% url 'core:logout' %}" onclick="return confirm('¿Desea cerrar la sesion')">Cerrar Sesion</a></li>
    
{% endblock %}

{% block content %}

<section class="auth-hero">
  <div class="container d-flex justify-content-center">
    <div class="card shadow-lg w-100" style="max-width: 1100px;">
      <div class="card-body p-4 p-md-5">

        <h1 class="h4 mb-3">
          {% if object %}Editar propiedad{% else %}Crear propiedad{% endif %}
        </h1>
        <p class="text-muted mb-4">
          Completa los datos de la propiedad que quieres gestionar en StockPRO.
        </p>

        {# Errores generales del formulario #}
        {% if form.non_field_errors %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> {{ form.non_field_errors }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endif %}

        

        <form id="propiedad-form"
              method="post"
              enctype="multipart/form-data"
              class="row g-3 needs-validation"
              novalidate>
          {% csrf_token %}

          <!-- Rol, Tipo, Estado -->
          <div class="col-md-4">
            <label for="{{ form.rol_sii.id_for_label }}" class="form-label">{{ form.rol_sii.label }}</label>
            {{ form.rol_sii }}
            {% if form.rol_sii.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.rol_sii.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="col-md-4">
            <label for="{{ form.tipo.id_for_label }}" class="form-label">{{ form.tipo.label }}</label>
            {{ form.tipo }}
            {% if form.tipo.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.tipo.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="col-md-4">
            <label for="{{ form.estado.id_for_label }}" class="form-label">{{ form.estado.label }}</label>
            {{ form.estado }}
            {% if form.estado.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.estado.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Dirección -->
          <div class="col-12">
            <label for="{{ form.direccion.id_for_label }}" class="form-label">{{ form.direccion.label }}</label>
            {{ form.direccion }}
            {% if form.direccion.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.direccion.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Comuna / Región -->
          <div class="col-md-6">
            <label for="{{ form.comuna.id_for_label }}" class="form-label">{{ form.comuna.label }}</label>
            {{ form.comuna }}
            {% if form.comuna.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.comuna.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="col-md-6">
            <label for="{{ form.region.id_for_label }}" class="form-label">{{ form.region.label }}</label>
            {{ form.region }}
            {% if form.region.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.region.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Superficies -->
          <div class="col-md-6">
            <label for="{{ form.sup_construida_m2.id_for_label }}" class="form-label">{{ form.sup_construida_m2.label }}</label>
            {{ form.sup_construida_m2 }}
            {% if form.sup_construida_m2.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.sup_construida_m2.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="col-md-6">
            <label for="{{ form.sup_terreno_m2.id_for_label }}" class="form-label">{{ form.sup_terreno_m2.label }}</label>
            {{ form.sup_terreno_m2 }}
            {% if form.sup_terreno_m2.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.sup_terreno_m2.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Dormitorios / Baños / Estacionamientos -->
          <div class="col-md-4">
            <label for="{{ form.dormitorios.id_for_label }}" class="form-label">{{ form.dormitorios.label }}</label>
            {{ form.dormitorios }}
            {% if form.dormitorios.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.dormitorios.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="col-md-4">
            <label for="{{ form.banos.id_for_label }}" class="form-label">{{ form.banos.label }}</label>
            {{ form.banos }}
            {% if form.banos.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.banos.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="col-md-4">
            <label for="{{ form.estacionamientos.id_for_label }}" class="form-label">{{ form.estacionamientos.label }}</label>
            {{ form.estacionamientos }}
            {% if form.estacionamientos.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.estacionamientos.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Precio / Imagen -->
          <div class="col-md-6">
            <label for="{{ form.precio_ref_clp.id_for_label }}" class="form-label">{{ form.precio_ref_clp.label }}</label>
            {{ form.precio_ref_clp }}
            {% if form.precio_ref_clp.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.precio_ref_clp.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="col-md-6">
            <label for="{{ form.imagen.id_for_label }}" class="form-label">{{ form.imagen.label }}</label>
            {{ form.imagen }}
            {% if form.imagen.errors %}
              <div class="invalid-feedback d-block text-danger">{{ form.imagen.errors.0 }}</div>
            {% endif %}
          </div>

          
          <!-- Enlace a documentos (Google Drive) -->
          <div class="col-12">
            <label for="{{ form.url_docs.id_for_label }}" class="form-label">
              Enlace a documentos (Google Drive)
            </label>
            {{ form.url_docs }}

            {% if form.url_docs.errors %}
              <div class="invalid-feedback d-block">
                {{ form.url_docs.errors.0 }}
              </div>
            {% endif %}

            <small class="form-text text-muted">
              Pega aquí el link de Google Drive con los documentos de esta propiedad.
            </small>
          </div>

          <!-- Botones -->
          <div class="col-12 d-flex gap-2 mt-3">
            <button class="btn btn-primary" type="submit">
              {% if object %}Guardar cambios{% else %}Guardar{% endif %}
            </button>
            <a class="btn btn-outline-dark" href="{% url 'core:propiedadcrud' %}">Cancelar</a>
          </div>
          
        </form>

      </div>
    </div>
  </div>
</section>



    <script>
    (function() {
      var form = document.getElementById('createform');
      if (!form) return;

      form.addEventListener('submit', function(e) {
        // HTML5 validation check
        if (!form.checkValidity()) {
          e.preventDefault();
          e.stopPropagation();
          form.classList.add('was-validated');
          return false;
        }

        if (!confirm('¿Deseas crear la propiedad?')) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }

        // Si el usuario confirma, el formulario se envía normalmente
        // La vista en el servidor se encargará de redirigir a usregistrado
        return true;
      }, false);
    })();
    </script>  
{% endblock %}